<?php
ini_set("display_errors", On);
error_reporting(E_ALL);

require "database.php";
require "ldapserver.php";
$errorMessage;

session_start();

if (isset($_POST["login"]))
{
    try {
        onLogInClick();        
    }
    catch(Exception $e){
        $errorMessage = $e->getMessage();
    }
}


/*************** function *****************/

// ログインボタンがクリックされたら検証する
function onLogInClick()
{
    //$pass = fetchPasswordMySQL($_POST["name"]);
    
    if (isldapAuth($_POST["name"],$_POST["pass"]))
    {
        session_regenerate_id(true); //セッションハイジャック対策らしい
        $_SESSION["USERID"] = $_POST["name"];
        header("Location: main.php");
    }
    else 
    {
        throw new Exception("NameまたはPasswordに誤りがあります。");
    }
}


function fetchPasswordMySQL($name)
{
    $result = selectFromUser("name = '$name'");
    if ($result != NULL) 
	{
        $row = $result->fetch_assoc();
        return $row['pass'];
    }
    return NULL;
}
?>

<!DOCTYPE html>
<html>
    <head>
        <title>exploit site - ログイン</title>
        
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <!-- Bootstrap -->
        <link rel="stylesheet" href="./bootstrap.min.css">
        
        <link rel="stylesheet" href="./main.css" />
    </head>
    <body>
        <div class="contents">
            <div id="abstract">
                <h2>脆弱サイト</h2>
                <p>Webアプリケーションの脆弱性を体験できるサイトです。</p>
            </div>
            
            <div id="main_content">
                <h3>ログイン</h3>
                <?php if (!empty($errorMessage)) { ?>
                <div class="alert alert-danger" role="alert">
                    <strong style="margin-right: 1em;">エラー</strong>
                    <?php echo $errorMessage;?>
                </div>
                <?php } ?>
                
                <form method="post" action="./index.php">
                    <div class="form-group">
                        <label for="input-name">Name</label>
                        <input required type="text" class="form-control" id="input-name" name="name" placeholder="Enter name">
                    </div>
                    <div class="form-group">
                        <label for="input-pass">Password</label>
                        <input required type="text" class="form-control" id="input-pass" name="pass" placeholder="Enter password">
                    </div>
                    <input type="submit" class="btn btn-default" id="submit-button" name="login" value="Sign In">                
                </form>
            </div>
        </div>
    </body>
</html>